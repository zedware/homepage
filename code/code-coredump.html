<html>
<!-- DW6 -->
<head>
<title>在Linux下产生并调试core文件</title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<style type="text/css">
<!--
.style1 {font-size: larger}
.style2 {color: #FF0000}
-->
</style>
</head>
<body bgcolor="#FFFFFF"> 
<p align="center" class="style1">在Linux下产生并调试core文件</p> 
<hr> 
<p>先看看我用的是个什么机器：</p>
<p>  $ uname -a<br>
  Linux dev 2.4.21-9.30AXsmp #1 SMP Wed May 26 23:37:09 EDT 2004 i686 i686 i386 GNU/Linux</p>
<p>再看看默认的一些参数，注意core file size是个0，程序出错时不会产生core文件了。</p>
<p>$ ulimit -a<br>
  <span class="style2">core file size (blocks, -c) 0</span><br>
  data seg size (kbytes, -d) unlimited<br>
  file size (blocks, -f) unlimited<br>
  max locked memory (kbytes, -l) 4<br>
  max memory size (kbytes, -m) unlimited<br>
  open files (-n) 2048<br>
  pipe size (512 bytes, -p) 8<br>
  stack size (kbytes, -s) 10240<br>
  cpu time (seconds, -t) unlimited<br>
  max user processes (-u) 7168<br>
  virtual memory (kbytes, -v) unlimited</p>
<p>写个简单的程序，看看core文件是不是会被产生。</p>
<p>$ more foo.c</p>
<p>#include &lt;stdio.h&gt;</p>
<p>static void sub(void);</p>
<p>int main(void)<br>
  {<br>
  &nbsp;&nbsp;&nbsp;&nbsp;sub();<br>
  &nbsp;&nbsp;&nbsp;&nbsp;return 0;<br>
  }</p>
<p>static void sub(void)<br>
  {<br>
  &nbsp;&nbsp;&nbsp;&nbsp;int *p = NULL;</p>
<p> <span class="style2">&nbsp;&nbsp;&nbsp;&nbsp;/* derefernce a null pointer, expect core dump. */<br>
&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%d&quot;, *p);</span><br>
  }</p>
<p>$ gcc -Wall -g foo.c<br>
  $ ./a.out<br>
  <span class="style2">Segmentation fault</span></p>
<p>$ ls -l core.*<br>
  <span class="style2">ls: core.*: No such file or directory</span></p>
<p>没有找到core文件，我们改改ulimit的设置，让它产生。1024是随便取的，要是core文件大于1024个块，就产生不出来了。</p>
<p>$ ulimit -c 1024</p>
<p>$ ulimit -a<br>
  <span class="style2">core file size (blocks, -c) 1024</span><br>
  data seg size (kbytes, -d) unlimited<br>
  file size (blocks, -f) unlimited<br>
  max locked memory (kbytes, -l) 4<br>
  max memory size (kbytes, -m) unlimited<br>
  open files (-n) 2048<br>
  pipe size (512 bytes, -p) 8<br>
  stack size (kbytes, -s) 10240<br>
  cpu time (seconds, -t) unlimited<br>
  max user processes (-u) 7168<br>
  virtual memory (kbytes, -v) unlimited</p>
<p>$ ./a.out<br>
  <span class="style2">Segmentation fault (core dumped)</span><br>
  $ ls -l core.*<br>
  <span class="style2">-rw------- 1 uniware uniware 53248 Jun 30 17:10 core.9128</span></p>
<p>注意看上述的输出信息，多了个<span class="style2">(core dumped)</span>。确实产生了一个core文件，9128是该进程的PID。我们用GDB来看看这个core。</p>
<p>$ <span class="style2">gdb --core=core.9128</span><br>
  GNU gdb Asianux (6.0post-0.20040223.17.1AX)<br>
  Copyright 2004 Free Software Foundation, Inc.<br>
  GDB is free software, covered by the GNU General Public License, and you are<br>
  welcome to change it and/or distribute copies of it under certain conditions.<br>
  Type &quot;show copying&quot; to see the conditions.<br>
  There is absolutely no warranty for GDB. Type &quot;show warranty&quot; for details.<br>
  This GDB was configured as &quot;i386-asianux-linux-gnu&quot;.<br>
  Core was generated by `./a.out'.<br>
  Program terminated with signal 11, Segmentation fault.<br>
  #0 0x08048373 in ?? ()<br>
  (gdb) <span class="style2">bt</span><br>
  #0 0x08048373 in ?? ()<br>
  #1 0xbfffd8f8 in ?? ()<br>
  #2 0x0804839e in ?? ()<br>
  #3 0xb74cc6b3 in ?? ()<br>
  #4 0x00000000 in ?? ()<br>
  <br>
此时用bt看不到<span class="style2">b</span>ack<span class="style2">t</span>race，也就是调用堆栈，原来GDB还不知道符号信息在哪里。我们告诉它一下：</p>
<p>  (gdb)<span class="style2"> file ./a.out</span><br>
  Reading symbols from ./a.out...done.<br>
  Using host libthread_db library &quot;/lib/tls/libthread_db.so.1&quot;.<br>
  (gdb) <span class="style2">bt</span><br>
  <span class="style2">#0 0x08048373 in sub () at foo.c:17<br>
  #1 0x08048359 in main () at foo.c:8</span><br>
  <br>
此时backtrace出来了。</p>
<p>  (gdb) l<br>
  <span class="style2">8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sub();</span><br>
  9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;<br>
  10&nbsp;&nbsp;&nbsp;&nbsp; }<br>
  11<br>
  12 &nbsp;&nbsp;&nbsp;&nbsp;static void sub(void)<br>
  13 &nbsp;&nbsp;&nbsp;&nbsp;{<br>
  14 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int *p = NULL;<br>
  15<br>
  16 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* derefernce a null pointer, expect core dump. */<br>
  <span class="style2">17 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;%d&quot;, *p);</span><br>
  (gdb)<br>
</p>
<div align="center"> 
  <hr> 
  <div align="center"><a href="mailto:zedware_at_gmail_dot_com">Copyright 2006-2007,zedware_at_gmail_dot_com</a><br> 
    Last modified on
    <!-- #BeginDate format:fcIS1 -->Friday, 2006-06-30<!-- #EndDate --> 
  </div> 
</div> 
</body>
</html>
